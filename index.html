<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ContentMine Facts</title>
    
    <link href='https://fonts.googleapis.com/css?family=Roboto:400,700,300&subset=latin,greek,latin-ext' rel='stylesheet' type='text/css'>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:300,400,700&subset=latin,greek,latin-ext" rel="stylesheet">
    
    <link href="bower_components/bootstrap-css/css/bootstrap.min.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
  </head>
  <body>
    <header>
    </header>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="bower_components/bootstrap-css/js/bootstrap.min.js"></script>
    <script src="bower_components/jput/js/jput.min.js"></script>
    <script src="bower_components/lodash/lodash.js"></script>
    <script src="bower_components/datatables/media/js/jquery.dataTables.min.js"></script>
    <script src="bower_components/datatables/media/js/dataTables.bootstrap.min.js"></script>
    <script src="bower_components/datatables/media/js/dataTables.responsive.min.js"></script>
    <script src="bower_components/wikidata-sdk/dist/wikidata-sdk.js"></script>
    <script src="colors.js"></script>
    <script>
      var table
        , hash  = getHash()
        
        , column= [ 'cmid', 'pmid', 'pre', 'term', 'post', 'wdid' ]
        , desc  = {
          cmid: function (title) {return(
	    '<strong>'+title.split('.').map(function(v,i){if(i>0)return v.toLowerCase();return v}).join('.') +'</strong>'+
	    ' is an object identifier issued by the <a href="http://contentmine.org">ContentMine</a>.'
	  )}
        , pmid: function (title) {return(
	    '<strong>'+title + '</strong> is an article identifier issued by <a href="https://www.ncbi.nlm.nih.gov/pmc/">Pubmed Central</a>. '+
	    '<a href="https://www.ncbi.nlm.nih.gov/pmc/articles/' + title + '">Here\'s the article</a>'
	  )}
        , wdid: function (title) {return(
	    '<strong>'+title + '</strong> is an object identifier issued by <a href="https://wikidata.org">Wikidata</a>. '+
	    '<a href="https://wikidata.org/wiki/' + title + '">Here\'s the item</a>'
	  )}
        }
      
      window.onhashchange = checkHash
      
      function getHash () {
	var param = decodeURIComponent( window.location.hash.replace( /^#/, '' ) )
	  , parts = param.split( '=' )
	
	return {
	  key: parts[ 0 ].toLowerCase(),
	  val: (parts[ 1 ]||'').toLowerCase()
	}
      }
      
      function clearFilter() {
	$('#desc').hide()
	window.location.hash = ''
      }
      
      function checkHash() {
	hash = getHash()
	
	var index
	  , value
	  , columns = true
	  , title   = (hash.val||hash.key).toUpperCase()
	  , text
	
	if ( hash.val ) {
	    index = column.indexOf( hash.key )
	  , value = hash.val
	  
	  if (title&&desc.hasOwnProperty(hash.key)) text = desc[ hash.key ]( title )
	} else if ( hash.key ) {
	  if ( /^CM\./i.test( hash.key ) ) {
	    index = column.indexOf( 'cmid' )
	  , value = hash.key
	  
	    if ( title ) text = desc[ 'cmid' ]( title )
	  } else if ( /^PMC\d+/i.test( hash.key ) ) {
	    index = column.indexOf( 'pmid' )
	  , value = hash.key
	  
	    if ( title ) text = desc[ 'pmid' ]( title )
	  } else if ( /^Q\d+/i.test( hash.key ) ) {
	    index = column.indexOf( 'wdid' )
	  , value = hash.key
	  
	    if ( title ) text = desc[ 'wdid' ]( title )
	  } else {
	    columns = false
	    table.columns( 2, 3, 4 ).search( hash.key )
	  }
	} else {
	  table
	    .search( '' )
	    .columns().search( '' )
	    .draw()
	}
	
	if ( columns )
	  table.column( index ).search( value )
	
	if ( title&&text ) {
	  $('#desc-title').html(title)
	  $('#desc-text').html(text)
	  $('#desc').show()
	}
	
	table.draw()
      }
      
      function loadFile() {
        var input = document.getElementById('fileinput');
        var file = input.files[0];
        var fr = new FileReader();
        fr.onload = receivedText;
        fr.readAsText(file);
      }

      function loadDefault() {
        $.get('sample.json', function(file) {
          receivedText(file)
        }).fail((err) => {
          var e = {}
          e.target = {}
          e.target.result = err.responseText
          receivedText(e)}
        )
      }

      function receivedText(e) {
        lines = e.target.result.split('\n');
        var newArr = []
        for(var line = 0; line < lines.length; line++){
          try{
            var obj = JSON.parse(lines[line])
            obj._source.prefix = _.escape(obj._source.prefix)
            obj._source.post   = _.escape(obj._source.post  )
            obj._source.term   = _.escape(obj._source.term  )
	    newArr.push(obj)
	  } catch(e) {

	  }
        }
        
        var html = ''
        
        function contentmineID (cmid) {
	  return (
	    '<a href="#cmid='+cmid+'">'+
	      '<div class="icon"></div>' +
	      '<span>' + cmid + '</span>' +
	    '</a>'
	  )
        }
        
        function wikidataID (wid) {
          if (wid) {
            formattedString = `<a href="https://www.wikidata.org/entity/${wid}">${wid}</a>`//
            return formattedString
          }
          else return ''
        }
        
        function removeXML (str) {
	  return str.replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&?(#x)?.+?;/g,'').replace(
	    /^[^<]*>|<.+?>|<[^>]*$/g,
	    ' '
	  )
        }

        var colormap = {}

        function getColorNumber (cmid) {
          var dictionary = cmid.split('.')[1].split(/[0-9]/)[0]
          if (!(dictionary in colormap)) {
            var newColorValue=Math.max(1, ... _.values(colormap))+1
            if (Number.isInteger(newColorValue)) {
              colormap[dictionary] = newColorValue
            }
          }
          return colors[colormap[dictionary]]
        }

        function prependEnWiki (name) {
          return 'https://en.wikipedia.org/wiki/'+name
        }

        //return the value of the property of the string name if the target is an item
        function returnTargetOfProperty (response, wid, pid, cb) {
          try {
            var target = response.entities[wid].claims[pid][0].mainsnak.datavalue.value.amount
            if(response.entities[wid].claims[pid][0].mainsnak.datatype == "wikibase-item") {

            }
            cb(target)
          }
          catch (err) {}
        }

        function getWikiBaseItem (wid, cb) {
          $.ajax({
            url: wdk.getEntities(wid),
            jsonp: "callback",
            dataType: "jsonp",
            success: cb
          })
        }

        function createdRowFunc (row, data, dataIndex) {
          var color = getColorNumber(data[0])
          $(row).find('td.cmid .icon').css('background-color', color)
          var wid = $(data[5]).text()
          if (wid) {
            getWikiBaseItem(wid, function (response) {
                var title = response.entities[wid].sitelinks.enwiki.title
                if (title) {
                  var url = prependEnWiki(title)
                  var html = ` <a href="${url}"><img src="W_icon.png" alt="wikipedia_icon"</a>`//
                  $(row).find('td.term').append(html)
                }
                returnTargetOfProperty(response, wid, 'P1082', function (target) {
                  if (target) $(row).find('td.term img').attr('title',`Population of: ${target}`)
                })
              })
          }
        }

        $('#front-loading-matter').css('display', 'none')

        $.each(newArr, function(index, value) {
          html +=
          '<tr>' +
	    '<td class="cmid">'+ contentmineID(value._source.identifiers.contentmine) +'</td>' +
	    '<td class="pmid"><span><a href="#pmid='+value._source.cprojectID+'">'+ value._source.cprojectID+'</td>' +
	    '<td class="pre"><span>' + removeXML(value._source.prefix)+'</td>' +
	    '<td class="term"><span>'+ value._source.term+'</td>' +
	    '<td class="post"><span>'+ removeXML(value._source.post)+'</td>' +
	    '<td class="wdid"><span>'+ wikidataID(value._source.identifiers.wikidata)+'</td>' +
	  '</tr>';
        })
        
        $('tbody').append(html)
        
        if ( $.fn.dataTable.isDataTable( '#mytable' ) ) {
	  table = $('#mytable').DataTable();
	} else {
	  table = $('#mytable').DataTable( {
	    ordering  : true
	  , order     : [ [ 1, 'asc' ], [ 0, 'asc' ] ]
	  , createdRow: createdRowFunc
	  , autoWidth : false
	  , columnDefs: [
	      { targets: 0, width: '200px' }
	    , { targets: 1, width: '110px' }
	    , { targets: 3, width: '200px' }
	    , { targets: 5, width: '100px' }
	    ]
	  , search: {
	      caseInsensitive: true
	    }
	  , dom:
	      "<'row r-control'<'col-sm-6 c-length'l><'col-sm-6 c-search'f>>" +
	      "<'row r-table'<'col-sm-12'tr>>" +
	      "<'row r-page'<'col-sm-5 c-info'i><'col-sm-7 c-pagination'p>>"
	  } );
	}
	
	$('#mytable_filter input').on( 'input' , function () {
	  window.location.hash = table.search()
	} )
	
        $('#mytable').css('display', 'table')
        
        $('#mytable_filter label').append(
	  ' <button onclick="clearFilter()">Clear Filter</button>'
        )
        
        clearFilter()
      }
    </script>
    
    <main>
      <div id="front-loading-matter">
	<h1>ContentMine Facts Visualiser</h1>
	Choose a local ContentMine fact dump: (like <a href="https://zenodo.org/search?page=1&size=20&q=contentmine&file_type=json">these</a> on zenodo)
	<form id="jsonFile" name="jsonFile" enctype="multipart/form-data" method="post">
	  <fieldset>
	    <label class="btn btn-default btn-file">
	      Browse Files
	    <input type='file' id='fileinput' style="display: none;">
	  </label>
	    <input type='button' id='btnLoad' value='Load' onclick='loadFile();' class="btn btn-primary">
	  </fieldset>
	</form>
	  Or just use the a subset of the sample Zika dataset. Full version available from: <a href="https://doi.org/10.5281/zenodo.154505">here</a>
	<form>
	  <fieldset>
	    <input type='button' id='btnDefault' value='Load Zika Facts!' onclick="loadDefault();" class="btn btn-primary">
	  </fieldset>
	</form>
      </div>
      <header id="desc">
	<hr>
	<h1 id="desc-title"></h1>
	<hr>
	<p id="desc-text"></p>
	<hr>
      </header>
      <table class="table table-bordered" id="mytable" style="display: none" width="100%">
	<thead>
	  <tr>
	    <th><span>ContentMine ID</span>
	      <nav>
		<span class="material-icons">arrow_drop_up</span>
		<span class="material-icons">arrow_drop_down</span>
	      </nav>
	    </th>
	    <th><span>Article</span>
	      <nav>
		<span class="material-icons">arrow_drop_up</span>
		<span class="material-icons">arrow_drop_down</span>
	      </nav>
	    </th>
	    <th><span>Prefix</span>
	      <nav>
		<span class="material-icons">arrow_drop_up</span>
		<span class="material-icons">arrow_drop_down</span>
	      </nav>
	    </th>
	    <th><span>Fact</span>
	      <nav>
		<span class="material-icons">arrow_drop_up</span>
		<span class="material-icons">arrow_drop_down</span>
	      </nav>
	    </th>
	    <th><span>Postfix</span>
	      <nav>
		<span class="material-icons">arrow_drop_up</span>
		<span class="material-icons">arrow_drop_down</span>
	      </nav>
	    </th>
	    <th><span>Wikidata</span>
	      <nav>
		<span class="material-icons">arrow_drop_up</span>
		<span class="material-icons">arrow_drop_down</span>
	      </nav>
	    </th>
	  </tr>
	</thead>
      <tbody id="tbody">
      </tbody>
      </table>
    </main>

    <footer>
      <hr>
      <p class="text-muted credit">Port of <a href="https://github.com/tarrow">tarrow</a>'s <a href="http://tarrow.github.io/factvis">page</a></p>
      <p class="text-muted credit">The W icon (<img src="W_icon.png"/>) for links to Wikipedia is a trademark of and authored by the Wikimedia Foundation. It is released under a CC BY-SA 3.0 license</p>
    </footer>
    
  </body>
</html>
